#cloud-config
write_files:
  - path: /etc/llm-slo-runner.env
    permissions: "0644"
    owner: root:root
    content: |
      GITHUB_REPOSITORY=${github_repository}
      RUNNER_PAT_PARAMETER_NAME=${runner_pat_parameter_name}
      RUNNER_VERSION=${runner_version}
      RUNNER_HOME=/opt/actions-runner
      RUNNER_NAME_PREFIX=${runner_name_prefix}
      RUNNER_DEFAULT_LABELS=${runner_default_labels_csv}
      RUNNER_EXTRA_LABELS=${runner_extra_labels_csv}
      APPEND_KERNEL_VERSION_LABEL=${append_kernel_version_label}

  - path: /opt/actions-runner/bootstrap-ephemeral-runner.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      source /etc/llm-slo-runner.env

      mkdir -p "$RUNNER_HOME"
      cd "$RUNNER_HOME"
      if [[ ! -x ./config.sh ]]; then
        PKG="actions-runner-linux-x64-$RUNNER_VERSION.tar.gz"
        URL="https://github.com/actions/runner/releases/download/v$RUNNER_VERSION/$PKG"
        curl -fsSL "$URL" -o "$PKG"
        tar xzf "$PKG"
      fi
      ./bin/installdependencies.sh || true

  - path: /opt/actions-runner/register-and-run-loop.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      source /etc/llm-slo-runner.env
      cd "$RUNNER_HOME"
      RUNNER_PAT="${RUNNER_PAT:-}"

      json_token() {
        python3 -c 'import json,sys; print((json.load(sys.stdin).get("token") or "").strip())'
      }

      fetch_pat() {
        if [[ -n "$RUNNER_PAT" ]]; then
          echo "$RUNNER_PAT"
          return 0
        fi
        if command -v aws >/dev/null 2>&1; then
          aws ssm get-parameter --name "$RUNNER_PAT_PARAMETER_NAME" --with-decryption --query 'Parameter.Value' --output text 2>/dev/null || true
          return 0
        fi
        return 0
      }

      kernel_label() {
        local release major minor
        release="$(uname -r 2>/dev/null || true)"
        major="$(awk -F. '{print $1}' <<<"$release")"
        minor="$(awk -F. '{print $2}' <<<"$release")"
        if [[ "$major" =~ ^[0-9]+$ && "$minor" =~ ^[0-9]+$ ]]; then
          echo "kernel-${major}-${minor}"
        fi
      }

      build_labels() {
        local labels extra auto
        labels="${RUNNER_DEFAULT_LABELS:-self-hosted,linux,ebpf}"
        extra="${RUNNER_EXTRA_LABELS:-}"
        if [[ -n "$extra" ]]; then
          labels="${labels},${extra}"
        fi
        if [[ "${APPEND_KERNEL_VERSION_LABEL:-true}" == "true" ]]; then
          auto="$(kernel_label)"
          if [[ -n "$auto" ]]; then
            labels="${labels},${auto}"
          fi
        fi
        tr '[:upper:]' '[:lower:]' <<<"$labels" \
          | awk -v RS=',' '{
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", $0);
              if (length($0) && !seen[$0]++) {
                out = out (out ? "," : "") $0
              }
            } END { print out }'
      }

      cleanup() {
        set +e
        if [[ -f .runner ]]; then
          PAT=$(fetch_pat)
          if [[ -n "$PAT" && "$PAT" != "None" ]]; then
            REMOVE_TOKEN=$(curl -fsSL -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $PAT" \
              "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runners/remove-token" | json_token 2>/dev/null || true)
            if [[ -n "$REMOVE_TOKEN" && "$REMOVE_TOKEN" != "null" ]]; then
              ./config.sh remove --token "$REMOVE_TOKEN" >/dev/null 2>&1 || true
            fi
          fi
        fi
      }
      trap cleanup EXIT INT TERM

      while true; do
        PAT=$(fetch_pat)
        if [[ -z "$PAT" || "$PAT" == "None" ]]; then
          echo "PAT fetch failed; set RUNNER_PAT or allow aws ssm get-parameter"
          sleep 15
          continue
        fi

        TOKEN=$(curl -fsSL -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $PAT" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runners/registration-token" | json_token)

        if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
          echo "registration token fetch failed; retrying"
          sleep 15
          continue
        fi

        RUNNER_NAME="$RUNNER_NAME_PREFIX-$(hostname)-$(date +%s)"
        RUNNER_LABELS="$(build_labels)"
        ./config.sh \
          --url "https://github.com/$GITHUB_REPOSITORY" \
          --token "$TOKEN" \
          --name "$RUNNER_NAME" \
          --no-default-labels \
          --labels "$RUNNER_LABELS" \
          --work "_work" \
          --ephemeral \
          --unattended \
          --replace

        ./run.sh || true

        ./config.sh remove --token "$TOKEN" >/dev/null 2>&1 || true
        rm -f .runner .credentials .credentials_rsaparams
        sleep 5
      done

  - path: /etc/systemd/system/gha-ephemeral-runner.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=GitHub Actions Ephemeral Runner (self-hosted,linux,ebpf)
      Wants=network-online.target docker.service
      After=network-online.target docker.service

      [Service]
      Type=simple
      User=runner
      Group=runner
      WorkingDirectory=/opt/actions-runner
      ExecStart=/opt/actions-runner/register-and-run-loop.sh
      Restart=always
      RestartSec=5
      EnvironmentFile=/etc/llm-slo-runner.env

      [Install]
      WantedBy=multi-user.target

runcmd:
  - sed -i 's#http://#https://#g' /etc/apt/sources.list
  - bash -lc 'for f in /etc/apt/sources.list.d/*.list; do [ -f "$f" ] && sed -i "s#http://#https://#g" "$f"; done'
  - apt-get update -y
  - DEBIAN_FRONTEND=noninteractive apt-get install -y ca-certificates curl jq unzip git docker.io awscli make
  - useradd -m -s /bin/bash runner || true
  - usermod -aG docker runner
  - mkdir -p /opt/actions-runner
  - chown -R runner:runner /opt/actions-runner
  - systemctl enable docker
  - systemctl start docker
  - curl -fsSL https://kind.sigs.k8s.io/dl/v0.24.0/kind-linux-amd64 -o /usr/local/bin/kind
  - chmod +x /usr/local/bin/kind
  - curl -fsSL https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl
  - chmod +x /usr/local/bin/kubectl
  - curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  - /opt/actions-runner/bootstrap-ephemeral-runner.sh
  - chown -R runner:runner /opt/actions-runner
  - systemctl daemon-reload
  - systemctl enable gha-ephemeral-runner.service
  - systemctl start gha-ephemeral-runner.service
