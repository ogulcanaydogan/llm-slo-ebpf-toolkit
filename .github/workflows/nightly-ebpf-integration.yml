name: nightly-ebpf-integration

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  runner-preflight:
    runs-on: ubuntu-latest
    outputs:
      has_ebpf_runner: ${{ steps.detect.outputs.has_ebpf_runner }}
      runner_count: ${{ steps.detect.outputs.runner_count }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        env:
          RUNNER_STATUS_TOKEN: ${{ secrets.RUNNER_STATUS_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: ./scripts/ci/check_ebpf_runner.sh

  privileged-kind-integration:
    needs: runner-preflight
    if: needs.runner-preflight.outputs.has_ebpf_runner == 'true'
    runs-on: [self-hosted, linux, ebpf]
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Build and unit tests
        run: |
          make build
          make test
          make correlation-gate
          make schema-validate
      - name: Build local demo images for kind
        run: |
          docker build -t llm-slo-agent:ci -f cmd/agent/Dockerfile .
          docker build -t llm-slo-rag-service:ci -f demo/rag-service/Dockerfile .
      - name: kind smoke and deploy baseline
        run: |
          make kind-up
          kind load docker-image --name llm-slo-lab llm-slo-agent:ci llm-slo-rag-service:ci
          kubectl apply -k deploy/observability
          kubectl apply -k deploy/k8s
          kubectl -n llm-slo-system set image daemonset/llm-slo-agent agent=llm-slo-agent:ci
          kubectl -n llm-slo-system rollout status daemonset/llm-slo-agent --timeout=180s
      - name: OTLP observability smoke
        run: make kind-observability-smoke
      - name: RAG demo service smoke
        run: |
          kubectl apply -k demo/rag-service/k8s
          kubectl -n observability set image deployment/rag-service rag-service=llm-slo-rag-service:ci
          kubectl -n observability rollout status deployment/rag-service --timeout=180s
          kubectl -n observability wait --for=condition=ready pod -l app=rag-service --timeout=120s
          kubectl -n observability port-forward svc/rag-service 18080:8080 &
          PF_PID=$!
          sleep 5
          RESP=$(curl -sS --max-time 30 http://localhost:18080/chat \
            -H 'content-type: application/json' \
            -d '{"prompt":"test","profile":"rag_medium","seed":42,"max_tokens":5,"stream":false}')
          echo "$RESP"
          echo "$RESP" | grep -q '"ttft_ms"' || { echo "FAIL: missing ttft_ms"; kill $PF_PID 2>/dev/null; exit 1; }
          echo "$RESP" | grep -q '"tokens_per_sec"' || { echo "FAIL: missing tokens_per_sec"; kill $PF_PID 2>/dev/null; exit 1; }
          echo "$RESP" | grep -q '"trace_id"' || { echo "FAIL: missing trace_id"; kill $PF_PID 2>/dev/null; exit 1; }
          echo "PASS: RAG demo service smoke"
          kill $PF_PID 2>/dev/null || true
      - name: Privileged eBPF smoke
        run: |
          if [ "$(id -u)" -eq 0 ]; then
            make ebpf-smoke
          else
            echo "skipping ebpf-smoke: runner is not root"
          fi
      - name: Incident smoke subset (DNS/retransmit/CPU synthetic)
        run: |
          COUNT=12 OUT_DIR=artifacts/benchmarks-nightly-matrix make chaos-matrix
          go run ./cmd/benchgen --out artifacts/benchmarks-nightly --scenario mixed_faults
      - name: Mark runner mode
        run: |
          cat > artifacts/benchmarks-nightly/runner_mode.txt <<EOF_MODE
          mode=full-self-hosted-ebpf
          runner_count=${{ needs.runner-preflight.outputs.runner_count }}
          timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          EOF_MODE
      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-ebpf-artifacts
          path: |
            artifacts/collector
            artifacts/benchmarks-nightly
            artifacts/benchmarks-matrix
            artifacts/benchmarks-nightly-matrix
          if-no-files-found: warn
      - name: kind teardown
        if: always()
        run: make kind-down

  synthetic-fallback-integration:
    needs: runner-preflight
    if: needs.runner-preflight.outputs.has_ebpf_runner != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Build and unit tests
        run: |
          make build
          make test
          make correlation-gate
          make schema-validate
      - name: Synthetic incident smoke subset (fallback)
        run: |
          COUNT=12 OUT_DIR=artifacts/benchmarks-nightly-matrix make chaos-matrix
          go run ./cmd/benchgen --out artifacts/benchmarks-nightly --scenario mixed_faults
      - name: Mark runner mode
        run: |
          cat > artifacts/benchmarks-nightly/runner_mode.txt <<EOF_MODE
          mode=fallback-synthetic-no-self-hosted-ebpf
          runner_count=${{ needs.runner-preflight.outputs.runner_count }}
          timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          note=Privileged eBPF and kind integration were skipped.
          EOF_MODE
      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-ebpf-artifacts
          path: |
            artifacts/benchmarks-nightly
            artifacts/benchmarks-matrix
            artifacts/benchmarks-nightly-matrix
          if-no-files-found: warn
