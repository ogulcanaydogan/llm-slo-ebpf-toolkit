name: kernel-compatibility-matrix

on:
  workflow_dispatch:
  schedule:
    - cron: "15 5 * * 1"

permissions:
  contents: read
  actions: read

jobs:
  runner-discovery:
    runs-on: ubuntu-latest
    outputs:
      count_5_15: ${{ steps.detect.outputs.count_5_15 }}
      count_6_8: ${{ steps.detect.outputs.count_6_8 }}
      reason: ${{ steps.detect.outputs.reason }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        env:
          RUNNER_STATUS_TOKEN: ${{ secrets.RUNNER_STATUS_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          mkdir -p artifacts/compatibility
          ./scripts/ci/check_runner_profiles.sh \
            --profiles kernel-5-15,kernel-6-8 \
            --out artifacts/compatibility/runner-discovery.json

          count_5_15="$(jq -r '.profiles["kernel-5-15"].count // 0' artifacts/compatibility/runner-discovery.json)"
          count_6_8="$(jq -r '.profiles["kernel-6-8"].count // 0' artifacts/compatibility/runner-discovery.json)"
          reason="$(jq -r '.reason // "unknown"' artifacts/compatibility/runner-discovery.json)"

          echo "count_5_15=${count_5_15}" >> "$GITHUB_OUTPUT"
          echo "count_6_8=${count_6_8}" >> "$GITHUB_OUTPUT"
          echo "reason=${reason}" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-runner-discovery
          path: artifacts/compatibility/runner-discovery.json

  compat-kernel-5-15:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_5_15 != '0'
    runs-on: [self-hosted, linux, ebpf, kernel-5-15]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Probe compatibility profile
        run: |
          mkdir -p artifacts/compatibility
          ./scripts/ci/kernel_compat_probe.sh --profile kernel-5-15 --out artifacts/compatibility/kernel-5-15.json
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-5-15
          path: artifacts/compatibility/kernel-5-15.json

  compat-kernel-5-15-unavailable:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_5_15 == '0'
    runs-on: ubuntu-latest
    steps:
      - name: Emit unavailable profile marker
        run: |
          mkdir -p artifacts/compatibility
          cat > artifacts/compatibility/kernel-5-15.json <<EOF
          {
            "profile": "kernel-5-15",
            "status": "unavailable",
            "detail": "no online self-hosted linux+ebpf runner with label kernel-5-15 (reason: ${{ needs.runner-discovery.outputs.reason }})",
            "timestamp_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-5-15
          path: artifacts/compatibility/kernel-5-15.json

  compat-kernel-6-8:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_6_8 != '0'
    runs-on: [self-hosted, linux, ebpf, kernel-6-8]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Probe compatibility profile
        run: |
          mkdir -p artifacts/compatibility
          ./scripts/ci/kernel_compat_probe.sh --profile kernel-6-8 --out artifacts/compatibility/kernel-6-8.json
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-6-8
          path: artifacts/compatibility/kernel-6-8.json

  compat-kernel-6-8-unavailable:
    needs: runner-discovery
    if: needs.runner-discovery.outputs.count_6_8 == '0'
    runs-on: ubuntu-latest
    steps:
      - name: Emit unavailable profile marker
        run: |
          mkdir -p artifacts/compatibility
          cat > artifacts/compatibility/kernel-6-8.json <<EOF
          {
            "profile": "kernel-6-8",
            "status": "unavailable",
            "detail": "no online self-hosted linux+ebpf runner with label kernel-6-8 (reason: ${{ needs.runner-discovery.outputs.reason }})",
            "timestamp_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compat-kernel-6-8
          path: artifacts/compatibility/kernel-6-8.json

  compatibility-report:
    needs:
      - compat-kernel-5-15
      - compat-kernel-5-15-unavailable
      - compat-kernel-6-8
      - compat-kernel-6-8-unavailable
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: kernel-compat-*
          merge-multiple: true
          path: artifacts/compatibility
      - name: Render compatibility report
        run: |
          RUN_ID="${{ github.run_id }}" ./scripts/ci/render_compatibility_report.sh artifacts/compatibility docs/compatibility.md
      - uses: actions/upload-artifact@v4
        with:
          name: kernel-compatibility-report
          path: |
            docs/compatibility.md
            artifacts/compatibility
